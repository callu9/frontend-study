# 12. 핵심 웹 지표

## 12.2. 핵심 웹 지표

핵심 웹 지표(Core Web Vital)는 웹사이트에서 뛰어난 사용자 경험을 제공하는데 필수적인 지표를 일컫는다.

- 구글이 꼽은 핵심 웹 지표
  - **LCP** (Largest Contentful Paint): 최대 콘텐트풀 페인트
  - **FID** (First Input Delay): 최초 입력 지연
  - **CLS** (Cumulative Layout Shift): 누적 레이아웃 이동

- 기타 특정 문제 진단 시 사용되는 지표
  - **TTFB** (Time To First Byte): 최초 바이트까지의 시간
  - **FCP** (First Contentful Paint): 최초 콘텐트풀 시간

## 12.3. LCP : 최대 콘텐트풀 페인트

### 12.3.1. 정의
- **LCP** (Largest Contentful Paint): 페이지가 처음으로 로드를 시작한 시점부터 <ins>뷰포트 내부</ins>에서 <ins>가장 큰 이미지 또는 텍스트</ins>를 렌더링하는 데 걸리는 시간
  - `<img>`
  - `<svg>` 내부의 `<image>`
  - `poster` 속성을 사용하는 `<video>`
  - `url()`을 통해 불러온 배경 이미지가 있는 요소
  - 텍스트와 같이 인라인 텍스트 요소를 포함하고 있는 블록 레벨 요소 (`<p>`, `<div>` 등)
- 페이지 로딩에 따라 변화하는 지표다.
- 부가적으로 사용자가 이용하는 디바이스의 크기에 따라 변화하는 지표다.

### 12.3.2. 의미

뷰포트 영역에 메인 콘텐츠가 화면에 완전히 전달되는 속도를 기준으로 한다면 사용자가 페이지 로딩이 완료됐다고 체감하는 시간과 비슷하게 측정할 수 있을 것이라는 기준으로, <ins>사용자에게 페이지의 정보를 화면에 전달하는 속도</ins>를 객관적으로 판단하기 위한 지표로 만들어졌다.

### 12.3.4. 기준 점수

- 지표 측정 방법: 해당 지표 응답 시간을 기준으로 점수를 판단한다.
  1. 직접 자바스크립트 API 호출
  2. 다른 도구 활용

- LCP(최대 콘텐트풀 페인트)의 점수 기준
  - 좋음: 2.5초 이내
  - 보통: 4초 이내
  - 나쁨: 4초 이상

### 12.3.5. 개선 방안

1. 최대 콘텐트풀 페인트 예상 영역에 추가적인 리소스 다운로드가 필요한 이미지 대신 노출 시간이 훨씬 빠른 텍스트로 채운다.

2. 이미지 노출 방법 중 `<img src="..." />`, `<video poster="..." />` 사용

    ```html
    <!-- (1) img -->
    <img src="lcp.jpg" ... />

    <!-- (2) svg -->
    <svg xmlns="http://www.w3.org/1000/svg">
      <image href="lcp.jpg" />
    </svg>

    <!-- (3) video.poster (비디오의 경우) -->
    <video poster="lcp.jpg"></video>

    <!-- (4) background-image: url() -->
    <div style="background-image: url(lcp.jpg)">...</div>
    ```

3. 조심해야 할 사항
    - 이미지 무손실 압축
    - `loading=lazy` 사용 지양
    - CSS 애니메이션 사용 지양
    - 클라이언트 단 빌드 지양
    - 최대 콘텐츠풀 리소스는 직접 호스팅

## 12.4. FID : 최초 입력 지연

### 12.4.1. 정의

- **FID** (First Input Delay): 웹사이트의 반응속도, 즉 반응성을 측정하는 지표
- 사용자가 얼마나 빠르게 웹페이지와의 상호작용에 대한 응답을 받을 수 있는지 측정하는 지표로, 최초의 입력 하나에 대해서만 판단

### 12.4.2. 의미

- 웹사이트 내부의 이벤트가 반응이 늦어지는 이유?
  - 해당 입력을 처리해야 하는 브라우저의 메인스레드가 바쁘기 때문
  - 즉, 싱글스레드인 자바스크립트가 대규모 렌더링, 혹은 대규모 자바스크립트 파일 분석 및 싱랭 등 다른 작업을 처리하는 데 리소스를 할애하고 있기 때문
- 사용자 경험 4가지 분류 (RAIL)
  - Response: 사용자의 입력에 대한 반응 속도 (50ms 미만)
  - Animation: 애니메이션의 각 프레임 생성 시간 (10ms 이하)
  - Idle: 유휴 시간을 극대화해 페이지가 사용자 입력에 응답하는 시간 (50ms 이내)
  - Load: 콘텐츠를 전달하고 인터랙션을 준비하는 시간 (5s 이내)

### 12.4.4. 기준 점수

- FID(최초 입력 지연)의 점수 기준
  - 좋음: 100ms 이내
  - 보통: 300ms 이내
  - 나쁨: 300ms 이상

### 12.4.5. 개선 방안

1. long task 분리
    - 긴 작업(long task): 실행을 완료하는 데 오래 걸리는 작업
    - 고려 사항
      - 웹페이지가 아닌 서버에서 처리하는 방법
      - 긴 작업을 여러개로 분리하는 방법
    - [참고] React의 Suspense와 lazy, Next.js의 dynamic

2. 자바스크립트 코드 최소화
    - 웹페이지에서 사용되지 않는 코드의 우선순위를 낮춰 지연 로딩 기법 혹은 필요로 하는 순간에 불러오는 방법
    - 폴리필(polyfill): 브라우저에서 지원하지 않는 기능을 사용하기 위해 웹페이지에서 직접 구현하고 집어넣는 코드를 의미.
      - 폴리필이 필요한 환경인가? or 꼭 필요한 폴리필인가?
      - [참고] 바벨의 `@babel/preset-env`, Next.js의 SWC
    - 타사 자바스크립트 코드 실행의 지연
      - `defer`: 병렬 다운로드, 페이지 로딩 후 실행
      - `async`: 병렬 다운로드, 다운로드 완료 시 실행
      - 가능하다면 `defer` > `async` 사용
      - `Intersection Observer` 이용 (뷰포트에 들어오는 시점에 광고 호출하는 등)

## 12.5. CLS : 누적 레이아웃 이동

### 12.5.1. 정의

- **CLS**(Cummulative Layout Shift): 생명주기 동안 발생하는 모든 예기치 않은 레이아웃 이동에 대한 지표

### 12.5.2. 의미

- 누적 레이아웃 이동은 사용자의 가시적인 콘텐츠에 영향을 미치는 뷰포트 내부의 요소에 대해서 측정한다.
- 사용자가 아무런 동작을 하지 않았음에도 불구하고 레이아웃 이동이 발생하는 경우도 포함한다.
- 최종 점수 계산 시 `영향분율 * 거리분율`
  - 영향분율 = 레이아웃 이동 발생 요소 전체 높이 / 뷰포트 높이
  - 거리분율 = 레이아웃 이동 발생 요소가 이동한 거리 / 뷰포트 높이

### 12.5.4. 기준 점수

- CLS(누적 레이아웃 이동)의 점수 기준
  - 좋음: 0.1 이하
  - 보통: 0.25 이하
  - 나쁨: 0.25 초과

### 12.5.5. 개선 방안

1. 삽입이 예상되는 요소를 위해 추가적인 공간 확보
    - `useEffect` 내부에서 요소에 영향을 미치는 작업(특히 뷰포트 내부에서 노출될 확률이 높은 작업)을 최소화
    - 스켈레톤 UI 등 미리 예상되는 공간을 확보
    - SSR (서버 사이드 렌더링)

2. 폰트 로딩 최적화

    폰트로 발생할 수 있는 문제는 두 가지
    - FOUT (flash of unstyled text): 기본 폰트로 보이고 있다가 뒤늦게 폰트가 적용되는 현상
    - FOIT (flash of invisible text): 기본 폰트도 없어 텍스트가 없는 채로 있다가 뒤늦게 폰트가 로딩되면서 페이지에 렌더링 되는 현상

    폰트 적용 시 아래에 유념해야 한다.

    1. `<link>`의 `rel=preload` 사용<br />: 웹페이지의 생명주기에서 초기에 불러와야 하는 중요한 리소스로 간주되므로 더 빠르게 사용할 수 있도록 브라우저가 준비해줄 수 있어, 페이지의 렌더링을 가로막거나 레이아웃을 방해할 가능성이 줄어든다.
    
    2. `font-family: optional;` 적용

3. 적절한 이미지 크기의 사용

### 12.5.6. 핵심 웹 지표는 아니지만 성능 확인에 중요한 지표들

#### TTFB (Time To First Byte, 최초 바이트까지의 시간)

- 브라우저가 웹페이지의 첫 번째 바이트를 수신하는데 걸리는 시간을 의미
- 즉, 페이지를 요청했을 때 최초의 응답이 오는 바이트까지가 얼마나 걸리는지를 측정하는 지표
- 600ms 이상 걸릴 경우 개선이 필요한 것으로 간주
- 서버 사이드 렌더링 어플리케이션에서 주의 깊게 봐야할 지표!


#### FCP (First Contentful Paint, 최초 콘텐츠풀 페인트)

- 페이지가 로드되기 시작한 시점부터 페이지 콘텐츠의 일부가 화면에 렌더링될 때까지의 시간을 측정
- 즉, 웹사이트에 접속한 순간부터 뭐라도 뜨기 시작한 시점까지의 시간을 의미 (텍스트, 이미지, svg 등)
- 1.8초 이내면 좋음, 3.0초 이내면 보통, 이후는 개선 필요
- 개선 방안
  - 최초 바이트까지의 시간(TTFB)을 개선
  - 렌더링을 가로막는 리소스 최소화하고 비동기적으로 로드하도록
  - Above the Fold에 대한 최적화: 가장 먼저 보이는 영역에 게으른 로딩 혹은 스크립트에 의존하는 것을 지양
  - 페이지 리다이렉트 최소화
  - DOM 크기 최소화